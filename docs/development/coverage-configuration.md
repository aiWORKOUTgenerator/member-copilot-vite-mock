# Coverage Configuration Guide

## Overview

This document outlines the coverage configuration for the Member Copilot Profile project, designed to maintain high code quality while minimizing repository size and CI/CD overhead.

## Configuration Details

### Jest Configuration (`jest.config.cjs`)

The coverage is configured to:
- **Only collect coverage in CI environments** (`collectCoverage: process.env.CI === 'true'`)
- **Generate minimal reports**: `text-summary` and `lcov` only
- **Exclude test files and setup files** from coverage collection
- **Set coverage thresholds** at 70% for all metrics

### Coverage Thresholds

```javascript
coverageThreshold: {
  global: {
    branches: 70,
    functions: 70,
    lines: 70,
    statements: 70
  }
}
```

### Files Excluded from Coverage

- Type definition files (`*.d.ts`)
- Test files (`*.test.{ts,tsx}`, `*.spec.{ts,tsx}`)
- Test directories (`__tests__/`, `__mocks__/`)
- Setup files (`setupJest.ts`)

## Available Scripts

### Development
```bash
npm test                    # Run tests without coverage
npm run test:coverage       # Run tests with coverage (CI mode)
npm run test:coverage:watch # Run tests with coverage in watch mode
```

### CI/CD
```bash
CI=true npm run test:coverage  # Force coverage collection
```

## CI/CD Integration

### GitHub Actions
The `.github/workflows/test.yml` file demonstrates proper CI coverage configuration:

1. **Environment variable**: `CI=true` triggers coverage collection
2. **Coverage upload**: Uses Codecov for coverage reporting
3. **Quality gates**: Coverage thresholds prevent merging if below 70%

### Coverage Reporting
- **Local development**: No coverage files generated by default
- **CI environment**: Generates `lcov.info` for external tools
- **External tools**: Codecov integration for detailed reporting

## Best Practices

### For Developers
1. **Local testing**: Use `npm test` for fast feedback
2. **Coverage checking**: Use `npm run test:coverage` before commits
3. **Watch mode**: Use `npm run test:coverage:watch` during development

### For CI/CD
1. **Always set `CI=true`** when running coverage
2. **Upload to external service** rather than storing in repository
3. **Use coverage thresholds** as quality gates
4. **Monitor trends** over time, not absolute numbers

### Repository Management
1. **Coverage directory is ignored** (`.gitignore`)
2. **No coverage files in version control**
3. **Clean repository size** and fast clones
4. **Reduced CI/CD storage costs**

## Troubleshooting

### Coverage Not Generating
- Ensure `CI=true` environment variable is set
- Check that files are not excluded by `collectCoverageFrom`
- Verify Jest configuration is loaded correctly

### Coverage Thresholds Failing
- Review uncovered code paths
- Add tests for missing scenarios
- Consider if uncovered code is necessary

### CI Coverage Upload Issues
- Verify `lcov.info` file exists in coverage directory
- Check Codecov service status
- Ensure proper authentication tokens

## Migration Notes

This configuration replaces the previous setup that:
- Generated large HTML reports
- Stored coverage files in version control
- Consumed significant repository space
- Slowed CI/CD pipelines

The new approach prioritizes:
- Minimal local overhead
- Fast CI/CD execution
- External coverage reporting
- Clean repository management